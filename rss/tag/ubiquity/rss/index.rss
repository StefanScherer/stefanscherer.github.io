<!DOCTYPE html>
<html><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" version="2.0"><channel><title>ubiquity - Stefan Scherer's Blog</title><description>Just my techie notes.</description><link>http://localhost:2368/</link><image><url>http://localhost:2368/favicon.png</url><title>ubiquity - Stefan Scherer's Blog</title><link>http://localhost:2368/</link></image><generator>Ghost 1.8</generator><lastBuildDate>Sat, 02 Jun 2018 13:23:51 GMT</lastBuildDate><atom:link href="http://localhost:2368/tag/ubiquity/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title>Ship happens. Secrets leaked to GitHub, what next?</title><description>&lt;div class="kg-card-markdown"&gt;&lt;p&gt;What a wonderful day. I just changed some code in one of my weekend projects and then it happened. I totally screwed it up, I accidentally pushed some secrets to a GitHub pull request. Yes, ship happens. We're all humans and make mistakes. We normally blog about success, but I&lt;/p&gt;&lt;/div&gt;</description><link>http://localhost:2368/ship-happens-secrets-leaked-to-github/</link><guid isPermaLink="false">5b1288ffd71f9600016d99e0</guid><category>GitHub</category><category>secrets</category><category>ubiquity</category><category>unify</category><dc:creator>Stefan Scherer</dc:creator><pubDate>Sat, 02 Jun 2018 13:15:26 GMT</pubDate><content:encoded>&lt;div class="kg-card-markdown"&gt;&lt;p&gt;What a wonderful day. I just changed some code in one of my weekend projects and then it happened. I totally screwed it up, I accidentally pushed some secrets to a GitHub pull request. Yes, ship happens. We're all humans and make mistakes. We normally blog about success, but I use my mistake to talk about how to fix this and how to prevent it from happening in the future again.&lt;/p&gt;
&lt;h1 id="thebadmistake"&gt;The bad mistake&lt;/h1&gt;
&lt;p&gt;Well, I edited some code of my flash script to flash Raspberry Pi SD cards. This tool can also inject configuration to boot your Pi without any manual interaction to a specified hostname, or add your WiFi settings so it can join your wireless network automatically.&lt;/p&gt;
&lt;p&gt;I pushed some code to a work-in-progress pull request when I saw my mistake on GitHub:&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/my-pull-request.png" alt="OMG, my pull request shows my WiFi PSK"&gt;&lt;/p&gt;
&lt;p&gt;WTF, how did I ... ?&lt;/p&gt;
&lt;p&gt;Well, for convenience reasons I kept a configuration file in the repo to easily flash a new SD card image with WiFi settings. And I can't really remember, but I eventually typed &lt;code&gt;git add .&lt;/code&gt; and &lt;code&gt;git push&lt;/code&gt; some minutes ago without recognising that this was a really, really bad idea.&lt;/p&gt;
&lt;h1 id="panicwhatnext"&gt;Panic, what next?&lt;/h1&gt;
&lt;p&gt;I immediatelly went to my Ubiquity Cloud controller and changed the Wireless Network Security Key.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/unify2.png" alt="Unify Wireless Network settings"&gt;&lt;/p&gt;
&lt;p&gt;But that was the next mistake. OK, I've changed the security key. But after a moment I realized that I also have some unattended boxes lying around in my house that use the old key to connect to my WiFi. My AirPort Express boxes for example are connected wirelessly.&lt;/p&gt;
&lt;h2 id="calmdownthinkandorganize"&gt;Calm down, think, and organize&lt;/h2&gt;
&lt;p&gt;OK, changing the Security Key as first step is probably not the best idea. I don't want to run to each box with a patch cable to reconfigure it. Instead I've changed the key back to the old, compromised one and reconfigured all my wireless devices that I can reach through WiFi.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/airport1.png" alt="AirPort devices"&gt;&lt;/p&gt;
&lt;h2 id="reconfigurewirelessdevicesfirst"&gt;Reconfigure wireless devices first&lt;/h2&gt;
&lt;p&gt;The devices with the dotted lines are connected through WiFi. Edit the wireless network password with the AirPort app on your Mac.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/airport2.png" alt="Change AirPort wireless network password"&gt;&lt;/p&gt;
&lt;p&gt;After that change they will drop out of WiFi as they now have the new, but not actually working password.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/airport-unreachable.png" alt="AirPort devices unreachable"&gt;&lt;/p&gt;
&lt;p&gt;Repeat that for all devices and think of other wireless devices that you can update without climbing up ladders or other hidden places.&lt;/p&gt;
&lt;h2 id="changeyourwifisecuritykey"&gt;Change your WiFi security key&lt;/h2&gt;
&lt;p&gt;After that I changed the wireless security key in the Unify cloud controller. Save the new WiFi key in your password manager, I use 1Password&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/uniqif-change-security-key2.png" alt="Change wireless security key in Unify cloud controller"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/1password-1.png" alt="Update key in 1Password password manager"&gt;&lt;/p&gt;
&lt;p&gt;After reconnecting to the new and now secure WiFi with the updated key I thought of the next steps. OK, the whole family has to update their smartphones and tables to connect to the WiFi again. That is managable. Now I'm coming to the next phase.&lt;/p&gt;
&lt;h1 id="cleaningup"&gt;Cleaning up&lt;/h1&gt;
&lt;p&gt;The next steps was to clean up the pull request to get rid of the accidentally added files. You might think when you are quick nobody has seen your change and you can skip changing your WiFi secret at all. I'll prove you wrong in the next few minutes.&lt;/p&gt;
&lt;p&gt;First I commented on my mistake to laugh at it, that's just relieving.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/github-pr-leak.png" alt="Comment your mistake on GitHub"&gt;&lt;/p&gt;
&lt;h2 id="removefilesremovecommits"&gt;Remove files, remove commits&lt;/h2&gt;
&lt;p&gt;Now it's time to clean up the pull request branch and remove the unwanted files. We could just do &lt;code&gt;git rm wifi.yml&lt;/code&gt;, but this will be added as a new commit to Git. Git has a history of each commit. I also want to get rid of these old commits.&lt;/p&gt;
&lt;p&gt;These were my steps to cleanup the pull request branch.&lt;/p&gt;
&lt;p&gt;I first squashed the pull request to one commit.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git rebase -i $(git merge-base $(git rev-parse --abbrev-ref HEAD) master)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then in the editor just &lt;code&gt;pick&lt;/code&gt; the first commit and change all other commits to &lt;code&gt;squash&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/git-squash.png" alt="git squash"&gt;&lt;/p&gt;
&lt;p&gt;Now I have only one commit. This commit can be easily undone with&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git reset HEAD~1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then add your secret files to the &lt;code&gt;.gitignore&lt;/code&gt; file and add everything and commit it again.&lt;/p&gt;
&lt;p&gt;Now your local pull request branch has only the files wanted in one single commit. But GitHub still stores the secret files. With the next command we'll fix that.&lt;/p&gt;
&lt;h2 id="gitpushf"&gt;git push -f&lt;/h2&gt;
&lt;p&gt;When things went bad sometimes a &lt;code&gt;git push -f&lt;/code&gt; is needed. But beware: This will overwrite the history in your Git repo. You really have to know what are you doing here. Don't use &lt;code&gt;git push -f&lt;/code&gt; in a panic. Calm down first. Otherwise you will make it even worse.&lt;/p&gt;
&lt;p&gt;But to remove the unwanted commits you need to overwrite the pull request branch.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/git-push-f-pr.png" alt="Dangerous: git push -f"&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git push -f origin add-version 
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id="everythingconcealednoway"&gt;Everything concealed? No way&lt;/h2&gt;
&lt;p&gt;When you now look at the GitHub pull request you might think that every secret vanished and it's safe to keep the old WiFi password. No, GitHub has an incredible database, don't think that that this information was removed.&lt;/p&gt;
&lt;p&gt;Each pull request can be commented and even after a &lt;code&gt;git push -f&lt;/code&gt; some of the comments got outdated on source that no longer exist. But this is still visible and retrievable.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/github-show-outdated-1.png" alt="GitHub show outdated comments"&gt;&lt;/p&gt;
&lt;p&gt;Look closer, there is a &amp;quot;Show outdated&amp;quot; link. You can open this&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/github-show-outdated-2.png" alt="GitHub show outdated comments still visible"&gt;&lt;/p&gt;
&lt;p&gt;So whenever such a data breach happens, be prepared to change your secrets. &lt;strong&gt;If it hurts, do it more often.&lt;/strong&gt;&lt;/p&gt;
&lt;h1 id="understandingthecause"&gt;Understanding the cause&lt;/h1&gt;
&lt;p&gt;After all this disaster recovery and cleanup there is still something to learn. What was the root cause and how can I prevent to make the same mistake again?&lt;/p&gt;
&lt;h2 id="gitadd"&gt;git add .&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;git add .&lt;/code&gt; command adds all modified and also untracked files and &lt;code&gt;git push&lt;/code&gt; pushes all this code to GitHub into your already open pull request branch.&lt;br&gt;
Yes, I'm lazy and often commit everything as I'm normally work on one thing in a project.&lt;/p&gt;
&lt;p&gt;I normally recognize such secret files from adding them, but as I realised the hard way is that you will type &lt;code&gt;git add .&lt;/code&gt; at some point in a hurry without even recognizing it.&lt;/p&gt;
&lt;p&gt;I scrolled up my terminal and found the situation where everything went wrong very soon.&lt;/p&gt;
&lt;p&gt;&lt;img src="http://localhost:2368/content/images/2018/06/git-untracked-files.png" alt="Git repo with untracked files"&gt;&lt;/p&gt;
&lt;p&gt;This is a bad smell having untracked files.&lt;/p&gt;
&lt;p&gt;What can this be fixed?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Learn to not use &lt;code&gt;git add .&lt;/code&gt;. I don't think that will work as I'm trained to type this and it's hard to break a habit.&lt;/li&gt;
&lt;li&gt;Maybe prevent &lt;code&gt;git add .&lt;/code&gt;?, see &lt;a href="https://stackoverflow.com/questions/25884007/disable-git-add-command"&gt;Stack Overflow&lt;/a&gt; I'm not going this hard way.&lt;/li&gt;
&lt;li&gt;Don't leave untracked files in your repo, yeah that sounds better.&lt;/li&gt;
&lt;li&gt;Add local secret files to your &lt;code&gt;.gitignore&lt;/code&gt; file. So a &lt;code&gt;git add .&lt;/code&gt; is harmless.&lt;/li&gt;
&lt;li&gt;Don't create such local secret files at all. Well you want something automated and just need config files with secrets.&lt;/li&gt;
&lt;li&gt;Create local files without the secrets and inject secrets on the fly. That also sounds like a good plan.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I'll look closer into the last idea to inject secrets on the fly. Don't leave secrets unprotected on your harddrive. Use command line interfaces for your password managers.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Use &lt;a href="https://www.passwordstore.org"&gt;Pass: The Standard Unix Password Manager&lt;/a&gt; that keeps secrets in GPG encrypted files which are also under version control in a separate Git repo.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You cannot change the past, you only can learn to make it better in the future.&lt;/p&gt;
&lt;p&gt;I hope you find this blog post useful and I love to hear your feedback and experience about similar mistakes or better tips how to protect yourself from doing mistakes. Just drop a comment below or ping me on Twitter &lt;a href="https://twitter.com/stefscherer"&gt;@stefscherer&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;</content:encoded></item></channel></rss></html>