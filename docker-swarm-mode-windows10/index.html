
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Getting started with Docker Swarm-mode on Windows 10</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../favicon.ico">

    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=c92b4cdda4">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,400">

    <link rel="canonical" href="https://stefanscherer.github.io/docker-swarm-mode-windows10/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="https://stefanscherer.github.io/docker-swarm-mode-windows10/amp/">
    
    <meta property="og:site_name" content="Stefan Scherer's Blog">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Getting started with Docker Swarm-mode on Windows 10">
    <meta property="og:description" content="Last Friday I noticed a blog post that Overlay Network Driver with Support for Docker Swarm Mode Now Available to Windows Insiders on Windows 10. A long awaited feature to use Docker Swarm on Windows, so it's time to test-drive it. Well you wonder why this feature is available on">
    <meta property="og:url" content="https://stefanscherer.github.io/docker-swarm-mode-windows10/">
    <meta property="article:published_time" content="2017-02-13T01:31:00.000Z">
    <meta property="article:modified_time" content="2017-02-13T07:50:45.000Z">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Swarm">
    <meta property="article:tag" content="Windows 10">
    <meta property="article:tag" content="Overlay">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Getting started with Docker Swarm-mode on Windows 10">
    <meta name="twitter:description" content="Last Friday I noticed a blog post that Overlay Network Driver with Support for Docker Swarm Mode Now Available to Windows Insiders on Windows 10. A long awaited feature to use Docker Swarm on Windows, so it's time to test-drive it. Well you wonder why this feature is available on">
    <meta name="twitter:url" content="https://stefanscherer.github.io/docker-swarm-mode-windows10/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Stefan Scherer">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Docker, Swarm, Windows 10, Overlay">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Stefan Scherer&#x27;s Blog",
        "logo": "https://stefanscherer.github.io/ghost/img/ghosticon.jpg"
    },
    "author": {
        "@type": "Person",
        "name": "Stefan Scherer",
        "image": {
            "@type": "ImageObject",
            "url": "https://stefanscherer.github.io/content/images/2016/03/Stefan-256-1.jpg",
            "width": 256,
            "height": 256
        },
        "url": "https://stefanscherer.github.io/author/stefan-scherer/",
        "sameAs": [
            "https://stefanscherer.github.io"
        ]
    },
    "headline": "Getting started with Docker Swarm-mode on Windows 10",
    "url": "https://stefanscherer.github.io/docker-swarm-mode-windows10/",
    "datePublished": "2017-02-13T01:31:00.000Z",
    "dateModified": "2017-02-13T07:50:45.000Z",
    "keywords": "Docker, Swarm, Windows 10, Overlay",
    "description": "Last Friday I noticed a blog post that Overlay Network Driver with Support for Docker Swarm Mode Now Available to Windows Insiders on Windows 10. A long awaited feature to use Docker Swarm on Windows, so it&#x27;s time to test-drive it. Well you wonder why this feature is available on",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://stefanscherer.github.io"
    }
}
    </script>

    <meta name="generator" content="Ghost 0.11">
    <link rel="alternate" type="application/rss+xml" title="Stefan Scherer's Blog" href="https://stefanscherer.github.io/rss/">
</head>
<body class="post-template tag-docker tag-swarm tag-windows-10 tag-overlay nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="index.html#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
            <li class="nav-home" role="presentation"><a href="https://stefanscherer.github.io/">Home</a></li>
            <li class="nav-talks" role="presentation"><a href="https://stefanscherer.github.io/talks/">Talks</a></li>
            <li class="nav-twitter" role="presentation"><a href="https://twitter.com/stefscherer">Twitter</a></li>
            <li class="nav-github" role="presentation"><a href="https://github.com/StefanScherer">GitHub</a></li>
    </ul>
        <a class="subscribe-button icon-feed" href="https://stefanscherer.github.io/rss/">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
            <a class="menu-button icon-menu" href="index.html#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-docker tag-swarm tag-windows-10 tag-overlay">

        <header class="post-header">
            <h1 class="post-title">Getting started with Docker Swarm-mode on Windows 10</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-02-13">13 February 2017</time>  on <a href="../tag/docker/">Docker</a>, <a href="../tag/swarm/">Swarm</a>, <a href="../tag/windows-10/">Windows 10</a>, <a href="../tag/overlay/">Overlay</a>
            </section>
        </header>

        <section class="post-content">
            <p>Last Friday I noticed a blog post that <a href="https://blogs.technet.microsoft.com/virtualization/2017/02/09/overlay-network-driver-with-support-for-docker-swarm-mode-now-available-to-windows-insiders-on-windows-10/">Overlay Network Driver with Support for Docker Swarm Mode Now Available to Windows Insiders on Windows 10</a>. A long awaited feature to use Docker Swarm on Windows, so it's time to test-drive it.</p>

<p>Well you wonder why this feature is available on Windows 10 and not Windows Server 2016. Sure it will make more sense in production running a Docker Swarm on multiple servers. The reason is that the Insider preview is the fastest channel to ship new features. Unfortunately there is no equivalent for Windows Server editions.</p>

<p>So if you need it for Windows Server you have to wait a little longer. You can indeed test Swarm-Mode on Windows Server 2016 and Docker 1.13, but only without the Overlay network.  To test Swarm-Mode with Overlay network you will need some machines running Windows 10 Insider 15031.</p>

<h2 id="preparation">Preparation</h2>

<p>In my case I use <a href="https://www.vagrantup.com">Vagrant</a> to spin up Windows VM's locally on my notebook. The advantage is that you can describe some test scenarios with a <code>Vagrantfile</code> and share it on GitHub.</p>

<p>I already have played with Docker Swarm-Mode in December and created a <a href="https://github.com/StefanScherer/docker-windows-box/tree/master/swarm-mode">Vagrant environment with some Windows Server 2016 VM's</a>. I'll re-use this scenario and just replace the underlying Vagrant box.</p>

<p>So the hardest part is to build a Windows 10 Insider 15031 VM. The <a href="https://www.microsoft.com/en-us/software-download/windowsinsiderpreviewadvanced">latest ISO file</a> with Windows 10 Insider 15025 is a good starting point. You have to switch to the Fast Ring to fetch the latest updates for Insider 15031.</p>

<p>Normally I use <a href="https://www.packer.io">Packer</a> with my <a href="https://github.com/StefanScherer/packer-windows">packer-windows</a> templates available on GitHub to automatically create such Vagrant boxes. In this case I only have a semi-automated template. Download the ISO file, build a VM with the <a href="https://github.com/StefanScherer/packer-windows/blob/my/windows_10_insider.json"><code>windows_10_insider.json</code></a> template and update it to Insider 15031 manually. With such a VM, build the final Vagrant box with the <a href="https://github.com/StefanScherer/packer-windows/blob/my/windows_10_docker.json"><code>windows_10_docker.json</code></a> Packer template.</p>

<p>What we now have is a Windows 10 Insider 15031 VM with the Containers and Hyper-V features activated, Docker 1.13.1 installed and both Microsoft Docker images downloaded. All the time consuming things should be done in a Packer build to make the final <code>vagrant up</code> a breeze.</p>

<p>In my case I had to add the Vagrant box with</p>

<pre><code>vagrant box add windows_10_docker ./windows_10_insider_15031_docker_vmware.box  
</code></pre>

<p>Vagrant 1.9.1 is able to use linked clones for VMware Fusion, VirtualBox and Hyper-V. So you need this big Vagrant box only once on disk. For the Docker Swarm only a clone will be started for each VM to save time and disk space.</p>

<h2 id="createtheswarm">Create the Swarm</h2>

<p>Now we use the prepared Vagrant environment and adjust it  </p>

<pre><code>git clone https://github.com/StefanScherer/docker-windows-box  
cd docker-windows-box/swarm-mode  
vi Vagrantfile  
</code></pre>

<p>In the <code>Vagrantfile</code> I had to change only the name of the box after <code>config.vm.box</code> to the newly added Vagrant box. This is like changing the <code>FROM</code> in a <code>Dockerfile</code>.</p>

<p><img src="../content/images/2017/02/git-diff-swarm-mode.png" alt="git diff Vagrantfile"></p>

<p>I also adjusted the memory a little bit to spin up more Hyper-V containers.</p>

<p>But now we are ready to create the Docker Swarm with a simple</p>

<pre><code>vagrant up  
</code></pre>

<p>This will spin up three Windows 10 VM's and build the Docker Swarm automatically for you. But using linked clones and the well prepared Vagrant basebox it takes only some minutes to have a complete Docker Swarm up and running.</p>

<h2 id="dockernodels">docker node ls</h2>

<p>After all three VM's are up and running, go into the first VM and open a PowerShell terminal. With</p>

<pre><code>docker node ls  
</code></pre>

<p>you can check if your Docker Swarm is active.</p>

<p><img src="../content/images/2017/02/swarm-mode.png" alt=""></p>

<h2 id="createanetwork">Create a network</h2>

<p>Now we create a new overlay network with</p>

<pre><code>docker network create --driver=overlay sample  
</code></pre>

<p>You can list all networks with <code>docker network ls</code> as there are already some others.</p>

<h2 id="createawhoamiservice">Create a whoami service</h2>

<p>With this new overlay network we start a simple service. I've prepared a Windows version of the <code>whoami</code> service. This is a simple webserver that just responds with its internal container hostname.</p>

<pre><code>docker service create --name=whoami --endpoint-mode dnsrr `  
  --network=sample stefanscherer/whoami-windows:latest
</code></pre>

<p>At the moment only DNS round robin is implemented as described in the Microsoft blog post. You cannot use to publish ports externally right now. More to come in the near future.</p>

<h2 id="runvisualizer">Run visualizer</h2>

<p>To make it more visible what happens in the next steps I recommend to run the Visualizer. On the first VM you can run the Visualizer with <a href="https://github.com/StefanScherer/docker-windows-box/blob/master/swarm-mode/scripts/run-portainer.ps1">this script</a>:</p>

<pre><code class="language-powershell">C:\vagrant\scripts\run-visualizer.ps1  
</code></pre>

<p>Now open a browser with another <a href="https://github.com/StefanScherer/docker-windows-box/blob/master/swarm-mode/scripts/open-visualizer.ps1">helper script</a>:</p>

<pre><code class="language-powershell">C:\vagrant\scripts\open-visualizer.ps1  
</code></pre>

<p>Now you can scale up the service to spread it over your Docker swarm.</p>

<pre><code>docker service scale whoami=4  
</code></pre>

<p>This will bring up the service on all three nodes and one of the nodes is running two instances of the whoami service.</p>

<p><img src="../content/images/2017/02/visualizer.png" alt="Visualizer"></p>

<p>Just play around scaling the service up and down a little bit.</p>

<h2 id="buildandcreateanotherservice">Build and create another service</h2>

<p>As I've mentioned above you cannot publish ports and there is no routing mesh at the moment. So the next thing is to create another service that will access the <code>whoami</code> service inside the overlay network. On Linux you probably would use <code>curl</code> to do that. I tried just a simple PowerShell script to do the same.</p>

<p>Two small files are needed to create a Docker image. First the simple script <code>askthem.ps1</code>:</p>

<pre><code class="language-powershell">while ($true) {  
  (Invoke-WebRequest -UseBasicParsing http://whoami:8000).Content
  Start-Sleep 1
}
</code></pre>

<p>As you can see the PowerShell script will access the webserver with the hostname <code>whoami</code> on port 8000.</p>

<p>Now put this Script into a Docker image with this <code>Dockerfile</code>:</p>

<pre><code class="language-Dockerfile">FROM microsoft/nanoserver  
COPY askthem.ps1 askthem.ps1  
CMD ["powershell", "-file", "askthem.ps1"]  
</code></pre>

<p>Now build the Docker image with</p>

<pre><code>docker build -t askthem .  
</code></pre>

<p>We now can start the second service that consumes the whoami service.</p>

<pre><code>docker service create --name=askthem --network=sample askthem:latest  
</code></pre>

<p>You now should see one instance of the newly created <code>askthem</code> service. Let's have a look at the logs. As this Vagrant environment enables the experimental features of Docker we are able to get the logs with this command:</p>

<pre><code>docker service logs askthem  
</code></pre>

<p>In my case I had luck and the <code>askthem</code> service got a response from one of the <code>whoami</code> containers that is running on a different Docker node.</p>

<p><img src="../content/images/2017/02/windows10-swarm-mode.png" alt="Windows 10 Swarm-Mode"></p>

<p>I haven't figured out why all the responses are from the same container. Maybe PowerShell or the <code>askthem</code> container itself caches the DNS requests. </p>

<p>But it still proves that overlay networking is working across multiple Windows machines.</p>

<h2 id="moretoplaywith">More to play with</h2>

<p>The Vagrant environment has some more things prepared. You also can spin up <a href="http://portainer.io">Portainer</a> that gives you a nice UI to your Docker swarm. You can have a look at your Nodes, the Docker images, the containers and services running and so on.</p>

<p>I also found out that you can scale services in the Portainer UI by changing the replicas. Running Visualizer and Portainer side-by-side demonstrates that:</p>

<p><img src="../content/images/2017/02/visualizer-portainer.gif" alt="Visualizer and Portainer"></p>

<h2 id="conclusion">Conclusion</h2>

<p>I think this setup can help you trying out the new Overlay network in Windows 10 Insider, and hopefully in Windows Server 2016 very soon as well.</p>

<p>As always, please leave a comment if you have questions or improvements or want to share your thoughts. You can follow me on Twitter <a href="https://twitter.com/stefscherer">@stefscherer</a>.</p>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../author/stefan-scherer/" style="background-image: url(../content/images/2016/03/Stefan-256-1.jpg)"><span class="hidden">Stefan Scherer's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../author/stefan-scherer/">Stefan Scherer</a></h4>

                    <p>Read <a href="../author/stefan-scherer/">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Germany</span>
                    <span class="author-link icon-link"><a href="https://stefanscherer.github.io">https://stefanscherer.github.io</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Getting%20started%20with%20Docker%20Swarm-mode%20on%20Windows%2010&amp;url=https://stefanscherer.github.io/docker-swarm-mode-windows10/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://stefanscherer.github.io/docker-swarm-mode-windows10/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://stefanscherer.github.io/docker-swarm-mode-windows10/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//stefanscherersblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                
        </footer>

    </article>
</main>

<aside class="read-next">
    <a class="read-next-story prev no-cover" href="../dockerizing-ghost-buster/">
        <section class="post">
            <h2>Dockerizing Ghost and Buster to run a blog on GitHub pages</h2>
            <p>I'm running this blog for nearly three years now. One of my first posts was the description how to…</p>
        </section>
    </a>
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="https://stefanscherer.github.io">Stefan Scherer's Blog</a> © 2017</section>
            <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/jquery.fitvids.js?v=c92b4cdda4"></script>
    <script type="text/javascript" src="../assets/js/index.js?v=c92b4cdda4"></script>

</body>
